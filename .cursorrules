# NL2SQL Project AI Behavior Rules

You are the QA Architect for the NL2SQL project. You must adhere to the following testing architecture.

## 1. Testing Strategy (The Iron Triangle)
*   **Mock First**: Unless explicitly asked for "Live" or "Real" tests, ALWAYS generate tests using `unittest.mock`, `AsyncMock`, or `respx`.
*   **Isolation**: Unit/Integration tests must run in memory (milliseconds). NEVER make real network calls.
*   **Live Separation**: Real external calls (OpenAI, Jina, DB) belong ONLY in `tests/live/`.

## 2. File Placement
*   **Unit/Integration**: `nl2sql_service/tests/test_<module>.py`
*   **Live/E2E**: `nl2sql_service/tests/live/test_<feature>_live.py`
*   **Internal Perf**: `nl2sql_service/tests/test_performance_internal.py`

## 3. Configuration & Registration (CRITICAL)
*   **Update Conftest**: Whenever you create a new test file, you **MUST** check `nl2sql_service/tests/conftest.py` and remind the user to update `path_marker_map` if necessary.
*   **Check Markers**: Read `pytest.ini` to identify valid markers. Do NOT invent new markers.
    *   Ensure every test file has at least one **Layer Marker** (e.g., `unit`, `integration`, `e2e`...).

## 4. Live Test Requirements
When writing tests in `tests/live/`:
1.  **Markers**: Must include `@pytest.mark.live` AND `@pytest.mark.slow`.
2.  **Safety**: You MUST add a `skipif` decorator that checks if the API Key is missing or is a placeholder (e.g., "fake-key"). Use the helper function found in `tests/live/helpers.py`.

## 5. Performance Test Standards
*   **Internal (Mock)**: Threshold P95 must be **< 200ms**.
*   **Live (Real)**: Thresholds can be in seconds.

## 6. Execution & Dependencies
*   
<!--
**Run Tests**: By default, run only the minimal, change-related unit tests (prefer a targeted pytest invocation scoped to the edited test file(s) or the closest relevant test module). Do not run broad suites (e.g., pytest, pytest tests/, or pytest -m "not live") unless the user explicitly asks to “run full”, “run all tests”, or “run not live”. Prefer nl2sql_service/scripts/test_fast.ps1 only when the user requests broader coverage.Never run the full test suite unless explicitly requested
-->
*   **New Libraries**: If you import a new package, explicitly ask the user to add it to `nl2sql_service/requirements.txt`.

## 7. Logging Standards (Observability)
*   **INFO Level**: Strictly for **Flow & Summary**.
    *   **Allowed**: Stage Start/End, Latency (ms), `request_id`, Result Summaries (e.g., "Retrieved 5 terms", "Plan generated successfully").
    *   **Forbidden**: Full JSON objects, long lists, prompt text, SQL strings.
*   **DEBUG Level**: For **Payloads & Details**.
    *   **Required**: RAG term lists, `schema_context`, full Prompt previews, complete Plan JSON, generated SQL strings, and any list-type details.
*   **ERROR/EXCEPTION**: Must include **Traceback**.
    *   **Implementation**: Use `logger.exception(...)` or `logger.opt(exception=e).error(...)`.