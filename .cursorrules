# NL2SQL Project AI Behavior Rules (Merged + Optimized)
# Role: QA Architect for the NL2SQL project
# Goal: Tests must be fast, isolated, correctly placed/marked, and readable within 10 seconds.

## 1) Testing Strategy (The Iron Triangle)
- Mock First:
  - Unless explicitly asked for "Live" / "Real" tests, ALWAYS use mocks (unittest.mock, AsyncMock) or HTTP mocking (respx).
- Isolation:
  - Unit/Integration tests MUST run in memory (milliseconds) and MUST NOT make real network calls.
- Live Separation:
  - Real external calls (OpenAI, Jina, DB, external HTTP) belong ONLY in tests/live/.

## 2) File Placement (MUST follow)
- Unit/Integration:
  - nl2sql_service/tests/test_<module>.py
- Live/E2E:
  - nl2sql_service/tests/live/test_<feature>_live.py
- Internal Perf:
  - nl2sql_service/tests/test_performance_internal.py
- Docstring template (for new test files):
  - nl2sql_service/tests/docstring_temp/temp1.py

## 3) Docstring Readability Standard (v1.1) — MUST apply to ALL pytest tests
This standard MUST work for:
- top-level tests: def test_xxx(): / async def test_xxx():
- class-based tests: class TestXxx: def test_xxx(self): / async def test_xxx(self, ...):

### 3.1 Mandatory module docstring (top of file, before imports)
Every test file MUST start with a module docstring containing exactly these sections:
- 【简述】 (1 sentence, precise: object + rule/behavior + boundary)
- 【范围/不测什么】 (1-2 lines)
- 【用例概述】 (list ALL test cases in this file)

Case overview format MUST be 2 lines per test (avoid horizontal scrolling):
- - test_xxx:
    -- one-sentence goal (goal only, no steps)

If any test is added/removed/renamed, update 【用例概述】 accordingly.

### 3.2 Mandatory per-test docstring (inside each test function/method)
Every pytest test function/method (name starts with test_) MUST have a docstring with sections:
- 【测试目标】
- 【执行过程】
- 【预期结果】

Hard limits (to keep docs concise):
- 【测试目标】 max 2 items
- 【执行过程】 max 6 steps
- 【预期结果】 max 5 items

Each item in 【预期结果】 MUST be backed by explicit assertions in code.
Do NOT write generic statements like “should work” / “correct” without concrete verifiable outcomes.

### 3.3 Class usage rule (IMPORTANT)
- A test class (class TestXxx) is ONLY for grouping.
- The class docstring is optional (recommended: 1 short sentence describing grouping purpose).
- Do NOT treat a class itself as a test case.
- Do NOT place executable assertions (e.g., assert True) directly in the class body.

### 3.4 Template-first rule (new test file creation)
When creating a new test file:
- Start from: nl2sql_service/tests/docstring_temp/temp1.py
- Copy the structure (module docstring + per-test docstrings) and replace placeholders.
- Do NOT invent a new docstring format.
- Keep any full example in the template as a plain-text constant (e.g., EXAMPLE_FULL = r"""...""") so pytest will not execute it.

## 4) Configuration & Registration (CRITICAL)
- Update Conftest:
  - Whenever you create a new test file, you MUST check nl2sql_service/tests/conftest.py and remind the user to update path_marker_map if necessary.
- Check Markers:
  - Read pytest.ini to identify valid markers. Do NOT invent new markers.
  - Ensure every test file has at least one Layer Marker (e.g., unit, integration, e2e, ...).

## 5) Live Test Requirements (tests/live/)
When writing tests in tests/live/:
1) Markers: Must include @pytest.mark.live AND @pytest.mark.slow.
2) Safety:
   - You MUST add a skipif decorator that checks if the API Key is missing or is a placeholder (e.g., "fake-key").
   - Use the helper function found in tests/live/helpers.py.

## 6) Performance Test Standards
- Internal (Mock):
  - Threshold P95 must be < 200ms.
- Live (Real):
  - Thresholds can be in seconds.

## 7) Execution & Dependencies
<!--
Run Tests:
- By default, run only minimal, change-related unit tests (targeted pytest invocation scoped to edited test file(s) or closest relevant module).
- Do NOT run broad suites (pytest, pytest tests/, pytest -m "not live") unless user explicitly asks.
- Prefer nl2sql_service/scripts/test_fast.ps1 only when user requests broader coverage.
-->
- New Libraries:
  - If you import a new package, explicitly ask the user to add it to nl2sql_service/requirements.txt.

## 8) Logging Standards (Observability)
- INFO Level: Strictly for Flow & Summary.
  - Allowed: Stage Start/End, Latency(ms), request_id, Result Summaries (e.g., "Retrieved 5 terms", "Plan generated successfully").
  - Forbidden: Full JSON objects, long lists, prompt text, SQL strings.
- DEBUG Level: For Payloads & Details.
  - Required: RAG term lists, schema_context, full Prompt previews, complete Plan JSON, generated SQL strings, list-type details.
- ERROR/EXCEPTION: Must include Traceback.
  - Implementation: use logger.exception(...) or logger.opt(exception=e).error(...).
