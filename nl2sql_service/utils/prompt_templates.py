"""
Prompt Templates Module

定义所有 LLM 提示模板，用于各个阶段的自然语言处理。
基于详细设计文档附录A的定义。
"""
# ============================================================
# Stage 1: Sub-Query Decomposition (子查询分解)
# ============================================================
PROMPT_SUBQUERY_DECOMPOSITION = """你是一个专业的查询分解助手（Query Decomposer）。你的任务是将用户的复杂查询问题拆解为多个原子子查询。

当前日期：{current_date}

用户问题：
{question}

请将上述问题拆解为多个原子子查询。每个子查询应该是独立的、可单独执行的查询。

**时间解析规则：**
- 当用户使用相对时间表达（如"今年"、"本月"、"上周"等）时，必须根据当前日期 {current_date} 转换为具体的绝对时间。
- 例如：如果当前日期是 2025-01-15，则"今年"应理解为"2025年"，"本月"应理解为"2025年1月"。
- 在子查询描述中，应使用明确的日期范围，避免使用模糊的相对时间表达。

**反幻觉规则：**
- 只基于用户问题中明确提到的信息进行分解，不要添加用户未提及的假设。
- 如果问题本身已经是原子查询，则只返回一个子查询。
- 如果问题包含多个独立的问题，则拆解为多个子查询。
- 每个子查询应该包含完整的查询意图，不依赖其他子查询的结果。

请以 JSON 格式返回结果，格式如下：
{{
  "sub_queries": [
    {{
      "id": "sq_1",
      "description": "第一个子查询的自然语言描述（已解析相对时间为绝对时间）"
    }},
    {{
      "id": "sq_2",
      "description": "第二个子查询的自然语言描述（已解析相对时间为绝对时间）"
    }}
  ]
}}

**输出要求：**
- sub_queries 必须是一个数组
- 至少包含一个子查询
- 每个子查询必须包含 id 和 description 字段
- description 应该是清晰、完整的自然语言查询描述，已将所有相对时间转换为绝对时间
"""


# ============================================================
# Stage 2: Plan Generation (计划生成)
# ============================================================
PROMPT_PLAN_GENERATION = """你是一个专业的数据分析师AI（Data Analyst AI）。你的任务是根据用户的自然语言查询，生成一个结构化的查询计划（QueryPlan）。

当前日期：{current_date}

用户子查询：
{sub_query_description}

可用的语义资源：
{available_resources}

**关键规则：不要发明新的ID！**
- 你只能使用 available_resources 中列出的指标ID（METRIC_*）、维度ID（DIM_*）、逻辑过滤器ID（LF_*）等。
- 绝对禁止创建新的ID或使用未在资源列表中出现的ID。
- 如果用户查询中提到的概念在资源列表中找不到对应的ID，请在 warnings 字段中记录此情况，并使用最接近的可用资源，或者将相关字段留空。

**查询计划结构：**
- intent: 查询意图，必须是 "AGG"（聚合查询）、"TREND"（趋势查询）或 "DETAIL"（明细查询）之一
- metrics: 指标列表，每个指标包含 id（必须以 METRIC_ 开头）和可选的 compare_mode（YOY/MOM/WOW）
- dimensions: 维度列表，每个维度包含 id（必须以 DIM_ 开头）和可选的 time_grain（DAY/WEEK/MONTH/QUARTER/YEAR）
- filters: 过滤器列表，每个过滤器包含 id、op（操作符）和 values（值列表）
- time_range: 时间范围（可选），类型可以是 LAST_N 或 ABSOLUTE
- order_by: 排序列表（可选），每个排序项包含 id 和 direction（ASC/DESC）
- limit: 结果限制数量（可选）
- warnings: 警告信息列表，用于记录不确定或无法匹配的情况

请以 JSON 格式返回一个单一的、扁平的 QueryPlan 对象（不是数组），格式如下：
{{
  "intent": "AGG",
  "metrics": [
    {{
      "id": "METRIC_GMV",
      "compare_mode": null
    }}
  ],
  "dimensions": [
    {{
      "id": "DIM_REGION",
      "time_grain": null
    }}
  ],
  "filters": [
    {{
      "id": "DIM_COUNTRY",
      "op": "EQ",
      "values": ["USA"]
    }}
  ],
  "time_range": {{
    "type": "LAST_N",
    "value": 30,
    "unit": "DAY"
  }},
  "order_by": [
    {{
      "id": "METRIC_GMV",
      "direction": "DESC"
    }}
  ],
  "limit": 10,
  "warnings": []
}}

**重要约束：**
1. 输出必须是单个 JSON 对象，不是数组
2. 所有 ID 必须来自 available_resources，禁止发明新ID
3. 如果某个字段不需要，可以设置为 null 或空数组 []
4. 时间范围必须根据用户查询中的时间表达正确设置
5. 如果无法匹配某些概念，必须在 warnings 中说明
"""


# ============================================================
# Stage 6: Data Insight (数据洞察 - 成功路径)
# ============================================================
PROMPT_DATA_INSIGHT = """你是一个专业的数据分析师。你的任务是根据SQL查询结果，生成清晰、准确的数据洞察总结。

用户原始问题：
{original_question}

查询结果数据：
{query_result_data}

查询结果元数据：
- 执行耗时：{execution_latency_ms} 毫秒
- 返回行数：{row_count} 行
- 是否截断：{is_truncated}

请基于上述查询结果，生成一个简洁、专业的数据洞察总结。总结应该：
1. 直接回答用户的问题
2. 突出关键数据和趋势
3. 使用清晰、易懂的语言
4. 如果数据为空或异常，应明确说明
5. 如果结果被截断，应在总结中提及

请以自然语言的形式返回总结，不要使用JSON格式。
"""


# ============================================================
# Stage 6: Clarification (澄清问题 - 澄清路径)
# ============================================================
PROMPT_CLARIFICATION = """你是一个友好、专业的数据查询助手。当用户的查询存在歧义或信息不足时，你需要生成一个礼貌、清晰的澄清问题。

用户原始问题：
{original_question}

无法确定的信息：
{uncertain_information}

请生成一个礼貌的澄清问题，帮助用户明确他们的查询意图。澄清问题应该：
1. 语气友好、专业
2. 明确指出需要澄清的具体点
3. 如果可能，提供一些选项供用户选择
4. 简洁明了，不要过于冗长

请以自然语言的形式返回澄清问题，不要使用JSON格式。
"""
